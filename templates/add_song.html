<!DOCTYPE html>
<html>
<head>
    <title>ë…¸ë˜ ì¶”ê°€</title>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Select2 ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ì¡°ì • */
        .select2-container {
            width: 350px !important;
        }
    </style>
</head>
<body>
    <h2>ğŸµ ë…¸ë˜ ì¶”ê°€</h2>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class=flashes>
        {% for message in messages %}
          <li style="color: red;">{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <form action="{{ url_for('add_song') }}" method="post">
        <p>
            <label for="artist_id_search">ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ (ê²€ìƒ‰):</label><br>
            <select id="artist_id_search" name="artist_id" required></select>
        </p>
        <p>
            <label for="album_id_search">ì•¨ë²” ì„ íƒ (ê²€ìƒ‰):</label><br>
            <select id="album_id_search" name="album_id" required></select>
        </p>
        <p>
            <label for="song_name">ë…¸ë˜ ì œëª©:</label><br>
            <input type="text" id="song_name" name="song_name" required size="50">
        </p>
        <p>
            <label for="release_date">ë…¸ë˜ ë°œë§¤ì¼ (ì„ íƒ):</label><br>
            <input type="date" id="release_date" name="release_date">
        </p>
        <fieldset style="margin-top: 15px;">
            <legend>ì²« í‰ì  ë‚¨ê¸°ê¸° (ì„ íƒ)</legend>
            <p>
                ì ìˆ˜: 
                <select name="score">
                    <option value="">-- ì„ íƒ ì•ˆí•¨ --</option>
                    <option value="5">5ì  (ìµœê³ )</option>
                    <option value="4">4ì </option>
                    <option value="3">3ì </option>
                    <option value="2">2ì </option>
                    <option value="1">1ì </option>
                </select>
            </p>
            <p>
                ë¦¬ë·° (ë…¸íŠ¸):<br>
                <textarea name="review" rows="4" a-cols="50"></textarea>
            </p>
        </fieldset>
        <p>
            <button type="submit">ë…¸ë˜ ë“±ë¡</button>
        </p>
    </form>
    <a href="{{ url_for('index') }}">[ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°]</a>

    <!-- jQuery and Select2 JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Artist Search
            var artistSelect = $('#artist_id_search');
            var albumSelect = $('#album_id_search');

            artistSelect.select2({
                placeholder: "-- ê²€ìƒ‰í•˜ì—¬ ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ --",
                allowClear: true,
                ajax: {
                    url: "{{ url_for('search_artists') }}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { q: params.term };
                    },
                    processResults: function (data) {
                        return { results: data };
                    },
                    cache: true
                }
            });

            // Album Search
            albumSelect.select2({
                placeholder: "-- ì•„í‹°ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --",
                allowClear: true,
                ajax: {
                    url: "{{ url_for('search_albums') }}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        // Get the selected artist ID
                        var artistId = artistSelect.val();
                        return {
                            q: params.term,
                            artist_id: artistId // Send artist_id to the server
                        };
                    },
                    processResults: function (data) {
                        return { results: data };
                    },
                    cache: true
                }
            });

            // When an artist is selected or cleared
            artistSelect.on('change', function() {
                // Clear the selected album
                albumSelect.val(null).trigger('change');

                var artistId = $(this).val();
                if (artistId) {
                    // If an artist is selected, update placeholder and enable search
                    albumSelect.select2('destroy').select2({
                        placeholder: "-- ê²€ìƒ‰í•˜ì—¬ ì•¨ë²” ì„ íƒ --",
                        allowClear: true,
                        ajax: {
                            url: "{{ url_for('search_albums') }}",
                            dataType: 'json',
                            delay: 250,
                            data: function (params) {
                                return {
                                    q: params.term,
                                    artist_id: artistSelect.val()
                                };
                            },
                            processResults: function (data) {
                                return { results: data };
                            },
                            cache: true
                        }
                    });
                } else {
                    // If no artist is selected, revert to the initial placeholder
                    albumSelect.select2('destroy').select2({
                        placeholder: "-- ì•„í‹°ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --",
                         allowClear: true,
                    });
                }
            });
             // ì´ˆê¸° ë¡œë“œ ì‹œ ì•„í‹°ìŠ¤íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ í”Œë ˆì´ìŠ¤í™€ë” ì„¤ì •
            if (!artistSelect.val()) {
                albumSelect.select2('destroy').select2({
                    placeholder: "-- ì•„í‹°ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --",
                     allowClear: true,
                });
            }
        });
    </script>
</body>
</html>
